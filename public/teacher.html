<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher - Realtime Classroom</title>
<style>
  video { width: 45%; border: 2px solid black; margin: 5px; background-color: black; }
  button { margin: 5px; padding: 10px; }
</style>
</head>
<body>
<h1>Teacher View</h1>

<video id="teacherVideo" autoplay playsinline muted></video>

<div>
  <button id="startBtn">â–¶ï¸ Start Streaming</button>
  <button id="shareBtn">ğŸ“º Share Screen</button>
  <button id="stopBtn">â›” Stop Sharing</button>
</div>

<h3>Students:</h3>
<ul id="studentsList"></ul>

<h3>Student Requests:</h3>
<ul id="requestsList"></ul>

<script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
<script>
const socket = io();
const teacherVideo = document.getElementById('teacherVideo');
const startBtn = document.getElementById('startBtn');
const shareBtn = document.getElementById('shareBtn');
const stopBtn = document.getElementById('stopBtn');
const studentsList = document.getElementById('studentsList');
const requestsList = document.getElementById('requestsList');

let localStream = null;
let screenStream = null;
const peers = {};

startBtn.onclick = async () => {
  localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  teacherVideo.srcObject = localStream;
  socket.emit("join-room", "teacher");
};

// Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©
shareBtn.onclick = async () => {
  if(!localStream) return;
  screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
  teacherVideo.srcObject = screenStream;

  for (let id in peers) {
    const pc = peers[id];
    const videoTrack = screenStream.getVideoTracks()[0];
    const sender = pc.getSenders().find(s => s.track.kind === 'video');
    if(sender) sender.replaceTrack(videoTrack);
  }
};

// Ø¥ÙŠÙ‚Ø§Ù Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©
stopBtn.onclick = () => {
  if(!screenStream) return;
  screenStream.getTracks().forEach(track => track.stop());
  teacherVideo.srcObject = localStream;

  for (let id in peers) {
    const pc = peers[id];
    const videoTrack = localStream.getVideoTracks()[0];
    const sender = peers[id].getSenders().find(s => s.track.kind === 'video');
    if(sender) sender.replaceTrack(videoTrack);
  }
};

// Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø§Ù†Ø¶Ù…
socket.on("student-joined", studentId => {
  const li = document.createElement("li");
  li.textContent = studentId;
  studentsList.appendChild(li);

  const pc = new RTCPeerConnection();
localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  pc.onicecandidate = event => {
    if(event.candidate){
      socket.emit("signal", { to: studentId, signal: { candidate: event.candidate } });
    }
  };

  pc.createOffer().then(offer => {
    pc.setLocalDescription(offer);
    socket.emit("signal", { to: studentId, signal: { sdp: offer } });
  });

  peers[studentId] = pc;
});

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ø·Ù„Ø§Ø¨
socket.on("signal", async data => {
  const pc = peers[data.from];
  if(!pc) return;
  if(data.signal.sdp){
    await pc.setRemoteDescription(new RTCSessionDescription(data.signal.sdp));
  }
  if(data.signal.candidate){
    await pc.addIceCandidate(new RTCIceCandidate(data.signal.candidate));
  }
});

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø§ÙŠÙƒ
socket.on("request-mic", studentId => {
  const li = document.createElement("li");
  li.textContent = studentId;
  const btn = document.createElement("button");
  btn.textContent = "Enable Mic";
  btn.onclick = () => {
    socket.emit("enable-mic", studentId);
    li.remove();
  };
  li.appendChild(btn);
  requestsList.appendChild(li);
});
</script>
</body>
</html>
